<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <meta charset="UTF-8" />
    <title>Distrito HipHop</title>
    
    <link rel="stylesheet" href="style.css">
    
  </head>
  <body>
    
    <!-- Pantalla de inicio -->
    <section id="start-screen">
      <img id="logo" src="Assets/logo-expo.webp" alt="">
      
      <section id="texto">
      <p>
        Al apuntar tu dispositivo m√≥vil a cada obra puedes ver y escuchar informaci√≥n relevante.
      </p>
      <p>
        Solo debes aceptar la solicitud de uso de c√°mara de tu dispositivo y seleccionar si es iPhone o Android.
      </p>
      </section>

      <button id="start-btn">Seguir con iPhone</button>
      <a href="android.html"><button class="android">Seguir con Android</button></a>
    </section>
    
    <a-scene
      mindar-image="imageTargetSrc: Assets/targets-3.mind;
                  filterMinCF: 0.0001;
                  filterBeta: 0.001;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <!-- Cargar assets (videos) -->
      <a-assets>

        <video id="video1" src="Assets/marker01-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video2" src="Assets/marker02-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video3" src="Assets/marker03-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video7" src="Assets/marker07-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video10" src="Assets/marker10-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video12" src="Assets/marker12-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video13" src="Assets/marker13-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video15" src="Assets/marker15-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
      
        <!-- P√°ginas PDF target 6 -->
        <img id="t1p1" src="Assets/marker06/marker06-01.jpg">
        <img id="t1p2" src="Assets/marker06/marker06-02.jpg">
        <img id="t1p3" src="Assets/marker06/marker06-03.jpg">
        
        <!-- P√°ginas PDF target 2 -->
        <img id="t2p1" src="Assets/marker06/marker06-01.jpg">
        <img id="t2p2" src="Assets/marker06/marker06-01.jpg">
        <img id="t2p3" src="Assets/marker06/marker06-01.jpg">
      
      </a-assets>

      <!-- C√°mara AR -->
      <a-camera
       position="0 0 0"
       look-controls="enabled: false"
       cursor="rayOrigin: mouse"
       raycaster="objects: .clickable; interval: 100; far: 20">
      </a-camera>

      <!-- Configuraci√≥n de m√∫ltiples marcadores -->
      <a-entity mindar-image-target="targetIndex: 0" id="marker1">
        <a-plane id="videoElement1" src="#video1" position="0 0 0" width="1" height="1.45"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1" id="marker2">
        <a-plane id="videoElement2" src="#video2" position="0 0 0" width="1" height="0.65"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 2" id="marker3">
        <a-plane id="videoElement3" src="#video3" position="0 0 0" width="1" height="0.75"></a-plane>
      </a-entity>

      <!-- PDF 1 -->
      <a-entity mindar-image-target="targetIndex: 4" id="pdfMarker1">
        <a-plane id="pdfPlane1" class="clickable" src="#t1p1" position="0 0 0" width="1" height="1.4"></a-plane>
      </a-entity>

      <!-- PDF 2 -->
      <a-entity mindar-image-target="targetIndex: 5" id="pdfMarker2">
        <a-plane id="pdfPlane2" class="clickable" src="#t2p1" position="0 0 0" width="1" height="1.4"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 6" id="marker7">
        <a-plane id="videoElement7" src="#video7" position="0 0 0" width="1" height="0.9"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 9" id="marker10">
        <a-plane id="videoElement10" src="#video10" position="0 0 0" width="1" height="0.65"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 11" id="marker12">
        <a-plane id="videoElement12" src="#video12" position="0 0 0" width="1" height="1"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 12" id="marker13">
        <a-plane id="videoElement13" src="#video13" position="0 0 0" width="1" height="1"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 14" id="marker15">
        <a-plane id="videoElement15" src="#video15" position="0 0 0" width="1" height="1"></a-plane>
      </a-entity>
    </a-scene>

    <script>
      document.getElementById("start-btn").addEventListener("click", () => {
        // Ocultar la pantalla de inicio
        document.getElementById("start-screen").style.display = "none";

        // Obtener los videos y forzar la reproducci√≥n
        const videos = document.querySelectorAll("video");
        videos.forEach(video => {
          video.muted = false; // Desactivar muteo
          video.play().catch(error => console.log("‚ö†Ô∏è No se pudo reproducir un video:", error));
        });
      });

      // Reproducci√≥n basada en detecci√≥n de marcador
      const setupVideoEvents = (markerId, videoId) => {
        const video = document.getElementById(videoId);
        const marker = document.getElementById(markerId);

        marker.addEventListener("targetFound", () => {
          console.log(`üîπ Marcador ${markerId} detectado, reproduciendo ${videoId}...`);
          video.play().catch(error => console.log(`‚ö†Ô∏è Error al reproducir ${videoId}:`, error));
        });

        marker.addEventListener("targetLost", () => {
          console.log(`üîπ Marcador ${markerId} perdido, pausando ${videoId}...`);
          video.pause();
        });
      };

      // Asignar eventos a cada marcador
      setupVideoEvents("marker1", "video1");
      setupVideoEvents("marker2", "video2");
      setupVideoEvents("marker3", "video3");
      setupVideoEvents("marker7", "video7");
      setupVideoEvents("marker10", "video10");
      setupVideoEvents("marker12", "video12");
      setupVideoEvents("marker13", "video13");
      setupVideoEvents("marker15", "video15");
    </script>




    <script>
      /* --- Configuraci√≥n de galer√≠as: IDs de a-plane ‚Üí lista de im√°genes en a-assets --- */
      const galleries = {
        pdfPlane1: ["#t1p1", "#t1p2", "#t1p3"],
        pdfPlane2: ["#t2p1", "#t2p2", "#t2p3"]
      };
      const currentPages = { pdfPlane1: 0, pdfPlane2: 0 };

      /* --- Utilidades para detectar si el marcador est√° visible --- */
      function isMarkerVisible(el) {
        const marker = el.closest('[mindar-image-target]');
        return !!(marker && marker.object3D && marker.object3D.visible);
      }

      /* --- Setup: Raycaster + vectores de THREE --- */
      const sceneEl = document.querySelector('a-scene');
      const THREE = AFRAME.THREE;
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();

      /* Recolecta los meshes asociados a los planos ".clickable" y guarda referencia al elemento */
      let planeEls = Array.from(document.querySelectorAll('.clickable'));
      let clickableMeshes = [];

      /* Reconstruye la lista de meshes (hay que hacerlo cuando la escena / assets est√°n listos) */
      function buildClickableMeshes() {
        clickableMeshes = [];
        planeEls.forEach(el => {
          el.object3D.traverse(node => {
            if (node.isMesh) {
              // enlazamos el mesh al elemento A-Frame para recuperarlo despu√©s
              node._aframeEl = el;
              clickableMeshes.push(node);
            }
          });
        });
        console.log('‚úÖ Clickable meshes:', clickableMeshes.length);
      }

      /* Espera a que la escena cargue (para asegurar camera y object3D) */
      sceneEl.addEventListener('loaded', () => {
        planeEls = Array.from(document.querySelectorAll('.clickable'));
        buildClickableMeshes();
      });

      /* Si a√±ades assets din√°micamente, vuelve a llamar a buildClickableMeshes() */

      /* --- Raycast desde coordenadas de pantalla ‚Üí devuelve el elemento A-Frame intersectado (o null) --- */
      function getIntersectedEl(clientX, clientY) {
        if (!sceneEl.camera) return null;
        mouse.x = (clientX / window.innerWidth) * 2 - 1;
        mouse.y = - (clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, sceneEl.camera);

        const intersects = raycaster.intersectObjects(clickableMeshes, true);
        if (intersects.length === 0) return null;

        // primer intersect
        const mesh = intersects[0].object;
        const el = mesh._aframeEl || mesh.el || null;
        return el;
      }

      /* --- Avanza la p√°gina correspondiente si el marcador est√° visible --- */
      function advancePageForEl(el) {
        if (!el || !el.id) return;
        const id = el.id;
        if (!galleries[id]) return;
        if (!isMarkerVisible(el)) {
          console.log('‚úñ Marcador no visible, no se avanza:', id);
          return;
        }
        const next = (currentPages[id] + 1) % galleries[id].length;
        // usar material.src para forzar actualizaci√≥n de textura
        el.setAttribute('material', 'src', galleries[id][next]);
        currentPages[id] = next;
        console.log(`üìÑ ${id} ‚Üí p√°gina ${next + 1}`);
      }

      /* --- Handler unificado para touch/mouse/pointer --- */
      function pointerDownHandler(evt) {
        const x = evt.touches ? evt.touches[0].clientX : evt.clientX;
        const y = evt.touches ? evt.touches[0].clientY : evt.clientY;
        const el = getIntersectedEl(x, y);
        if (el) advancePageForEl(el);
      }

      /* Registra listeners (touch y mouse) */
      window.addEventListener('touchstart', pointerDownHandler, { passive: true });
      window.addEventListener('mousedown', pointerDownHandler);

      /* Debug: puedes descomentar para forzar rebuild manual en consola */
      window.__rebuildClickableMeshes = buildClickableMeshes;
    </script>


  </body>
</html>
