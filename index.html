<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <meta charset="UTF-8" />
    <title>Distrito HipHop</title>
    
    <link rel="stylesheet" href="style.css">
    
  </head>
  <body>
    
    <!-- Pantalla de inicio -->
    <section id="start-screen">
      <img id="logo" src="Assets/logo-expo.webp" alt="">
      
      <section id="texto">
      <p>
        Al apuntar tu dispositivo móvil a cada obra puedes ver y escuchar información relevante.
      </p>
      <p>
        Solo debes aceptar la solicitud de uso de cámara de tu dispositivo y seleccionar si es iPhone o Android.
      </p>
      </section>

      <button id="start-btn">Seguir con iPhone</button>
      <a href="android.html"><button class="android">Seguir con Android</button></a>
    </section>

    <div id="pdf-overlay"><button id="pdf-open-btn">Abrir documento</button></div>
    
    <a-scene
      mindar-image="imageTargetSrc: Assets/targets-3.mind"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
    <!-- Cámara AR con cursor y raycaster (usa .clickable) -->
    <a-camera
      position="0 0 0"
      look-controls="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable; interval: 100; far: 20"
    ></a-camera>
    
      <!-- Cargar assets (videos) -->
      <a-assets>

        <video id="video1" src="Assets/marker01-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video2" src="Assets/marker02-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video3" src="Assets/marker03-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video7" src="Assets/marker07-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video9" src="Assets/marker09-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video10" src="Assets/marker10-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video12" src="Assets/marker12-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video13" src="Assets/marker13-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
        <video id="video15" src="Assets/marker15-asset.mp4" loop muted playsinline webkit-playsinline autoplay crossorigin="anonymous" preload="auto"></video>
      
      </a-assets>

      <!-- Configuración de múltiples marcadores -->
      <a-entity mindar-image-target="targetIndex: 0" id="marker1">
        <a-plane id="videoElement1" src="#video1" position="0 0 0" width="1" height="1.45"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1" id="marker2">
        <a-plane id="videoElement2" src="#video2" position="0 0 0" width="1" height="0.65"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 2" id="marker3">
        <a-plane id="videoElement3" src="#video3" position="0 0 0" width="1" height="0.75"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 6" id="marker7">
        <a-plane id="videoElement7" src="#video7" position="0 0 0" width="1" height="0.9"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 8" id="marker9">
        <a-plane id="videoElement9" src="#video9" position="0 0 0" width="1" height="0.65"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 9" id="marker10">
        <a-plane id="videoElement10" src="#video10" position="0 0 0" width="1" height="0.65"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 11" id="marker12">
        <a-plane id="videoElement12" src="#video12" position="0 0 0" width="1" height="1"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 12" id="marker13">
        <a-plane id="videoElement13" src="#video13" position="0 0 0" width="1" height="1"></a-plane>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 14" id="marker15">
        <a-plane id="videoElement15" src="#video15" position="0 0 0" width="1" height="1"></a-plane>
      </a-entity>


      <!-- PDFs -->
      <a-entity mindar-image-target="targetIndex: 3" id="markerPDF1">
        <a-plane id="pdfTrigger1" class="clickable" data-pdf="Assets/marker04.pdf" src="Assets/marker04.jpg" position="0 0 0"
          width="1" height="1.3"></a-plane>
      </a-entity>
      
      <a-entity mindar-image-target="targetIndex: 4" id="markerPDF2">
        <a-plane id="pdfTrigger2" class="clickable" data-pdf="Assets/marker05.pdf" src="Assets/marker05.jpg" position="0 0 0"
          width="1" height="1.3"></a-plane>
      </a-entity>
      
      <a-entity mindar-image-target="targetIndex: 5" id="markerPDF3">
        <a-plane id="pdfTrigger3" class="clickable" data-pdf="Assets/marker06.pdf" src="Assets/marker06.jpg" position="0 0 0"
          width="1" height="1.3"></a-plane>
      </a-entity>

    </a-scene>


    <script>
      document.getElementById("start-btn").addEventListener("click", () => {
        // Ocultar la pantalla de inicio
        document.getElementById("start-screen").style.display = "none";

        // Obtener los videos y forzar la reproducción
        const videos = document.querySelectorAll("video");
        videos.forEach(video => {
          video.muted = false; // Desactivar muteo
          video.play().catch(error => console.log("⚠️ No se pudo reproducir un video:", error));
        });
      });

      // Reproducción basada en detección de marcador
      const setupVideoEvents = (markerId, videoId) => {
        const video = document.getElementById(videoId);
        const marker = document.getElementById(markerId);

        marker.addEventListener("targetFound", () => {
          console.log(`🔹 Marcador ${markerId} detectado, reproduciendo ${videoId}...`);
          video.play().catch(error => console.log(`⚠️ Error al reproducir ${videoId}:`, error));
        });

        marker.addEventListener("targetLost", () => {
          console.log(`🔹 Marcador ${markerId} perdido, pausando ${videoId}...`);
          video.pause();
        });
      };

      // Asignar eventos a cada marcador
      setupVideoEvents("marker1", "video1");
      setupVideoEvents("marker2", "video2");
      setupVideoEvents("marker3", "video3");
      setupVideoEvents("marker7", "video7");
      setupVideoEvents("marker9", "video9");
      setupVideoEvents("marker10", "video10");
      setupVideoEvents("marker12", "video12");
      setupVideoEvents("marker13", "video13");
      setupVideoEvents("marker15", "video15");


        /***********************
       * Apertura de PDFs
       *
       * Estrategia:
       * 1) Intentamos abrir el PDF desde un listener 'touchstart' sobre el canvas (evento nativo => user gesture).
       * 2) Si falla (por cualquier razón), mostramos el overlay HTML; al pulsarlo abrimos el PDF.
       ***********************/

        const overlay = document.getElementById("pdf-overlay");
        const overlayBtn = document.getElementById("pdf-open-btn");
        let overlayUrl = null;

        function showOverlay(url) {
          overlayUrl = url;
          overlay.style.display = "block";
        }
        function hideOverlay() {
          overlayUrl = null;
          overlay.style.display = "none";
        }

        overlayBtn.addEventListener("click", () => {
          if (!overlayUrl) return;
          window.open(overlayUrl, "_blank", "noopener,noreferrer");
          hideOverlay();
        });

        // Asignamos llamada directa (por si click a-plane se traduce a evento A-Frame válido)
        document.querySelectorAll('.clickable').forEach(el => {
          // handler A-Frame click (puede ser bloqueado, pero dejamos por compat)
          el.addEventListener('click', (ev) => {
            const url = el.getAttribute('data-pdf');
            if (!url) return;
            const w = window.open(url, "_blank", "noopener,noreferrer");
            if (!w) { // si es null -> mostrar overlay
              showOverlay(url);
            }
          });
        });

        // === Touch raycast sobre el canvas (método más fiable en iOS) ===
        const sceneEl = document.querySelector('a-scene');
        sceneEl.addEventListener('loaded', () => {
          const canvas = sceneEl.renderer.domElement;
          if (!canvas) return;

          canvas.addEventListener('touchstart', (e) => {
            // Tomamos primer touch
            const touch = e.touches[0] || e.changedTouches[0];
            if (!touch) return;

            const rect = canvas.getBoundingClientRect();
            const x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
            const y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;

            const three = AFRAME.THREE;
            const pointer = new three.Vector2(x, y);
            const cam = sceneEl.camera;
            const ray = new three.Raycaster();
            ray.setFromCamera(pointer, cam);

            // Intersectar todos los objetos; filtramos por .clickable
            const intersects = ray.intersectObjects(sceneEl.object3D.children, true);
            for (let inter of intersects) {
              const obj = inter.object;
              const el = obj.el; // A-Frame vincula el object3D con el elemento
              if (el && el.classList && el.classList.contains('clickable')) {
                const url = el.getAttribute('data-pdf');
                if (url) {
                  // Este touchstart es un gesto de usuario: abrir tab
                  window.open(url, "_blank", "noopener,noreferrer");
                  e.preventDefault();
                  return;
                }
              }
            }
            // Si no hay intersección, no hacemos nada.
          }, { passive: false });
        });

        // Opcional: mostrar overlay cuando se detecta el marcador (UX)
        const markerPDF1 = document.getElementById('markerPDF1');
        const markerPDF2 = document.getElementById('markerPDF2');
        const markerPDF3 = document.getElementById('markerPDF3');

        if (markerPDF1) {
          markerPDF1.addEventListener('targetFound', () => {
            // muestra un pequeño indicador / instrucción: "Toca la imagen"
            // aquí decidimos no abrir nada automáticamente; solo mostramos overlay opción si user wants
            // showOverlay(el.getAttribute('data-pdf')); // opcional: mostrar overlay inmediatamente
          });
          markerPDF1.addEventListener('targetLost', hideOverlay);
        }
        if (markerPDF2) {
          markerPDF2.addEventListener('targetFound', () => { });
          markerPDF2.addEventListener('targetLost', hideOverlay);
        }
        if (markerPDF3) {
          markerPDF3.addEventListener('targetFound', () => { });
          markerPDF3.addEventListener('targetLost', hideOverlay);
        }


    </script>

  </body>
</html>
